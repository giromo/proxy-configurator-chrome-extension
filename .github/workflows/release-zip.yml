name: Create Clean ZIP Release for Chrome Extension (Only Install Files)

on:
  push:
    tags:
      - 'v*'  # فقط برای تگ‌ها مثل v2.0.0

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build  # ساخت dist/ با فایل‌های نهایی (manifest, bundle.js, icons, etc.)

      - name: Create ZIP of dist folder contents only (files at root)
        run: |
          # ورود به dist و ZIP فقط محتوای داخلش (بدون پوشه dist/)
          cd dist
          zip -r ../proxy-configurator-extension-v${{ github.ref_name }}.zip . -x "*/node_modules/*" "*/src/*" "*.log" ".git/*"  # ZIP با exclusions اضافی
          cd ..
          # چک محتوای ZIP (اختیاری برای دیباگ)
          unzip -l proxy-configurator-extension-v${{ github.ref_name }}.zip

      - name: Create Release and Attach ZIP
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: proxy-configurator-extension-v${{ github.ref_name }}.zip
          tag_name: ${{ github.ref }}
          name: 'Version ${{ github.ref_name }} - Clean Install ZIP'
          body: |
            ### تغییرات نسخه ${{ github.ref_name }}
            - ZIP فقط شامل فایل‌های ضروری برای نصب: `manifest.json`, `background.js`, `bundle.js`, `index.html`, `icons/` (بدون src/, README, LICENSE یا node_modules).
            - **نصب**: دانلود کن، unzip کن (فایل‌ها مستقیم در root هستن)، `chrome://extensions/` > Developer Mode > **Load unpacked** > پوشه unzip‌شده.

            **تست**: host: `proxy.example.com`, port: `1080`, type: SOCKS5.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
